name: Deploy to ECR and k3s
on: [push]   # Triggers on git push

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout code
      - uses: actions/checkout@v2

      # Step 2: Login to Amazon ECR
      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v1
        with:
          region: ap-northeast-2

      # Step 3: Build, tag, and push to ECR
      - name: Build and Push Docker Image
        run: |
          docker build -t my-app .
          docker tag my-app:latest ${{ secrets.ECR_REGISTRY }}/my-app:latest
          docker push ${{ secrets.ECR_REGISTRY }}/my-app:latest

      # Step 4: SSH into EC2 and update k3s deployment
      - name: Deploy to k3s
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}      # EC2 public IP
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }} # Base64-encoded key
          script: |
            kubectl set image deployment/my-app my-app=${{ secrets.ECR_REGISTRY }}/my-app:latest